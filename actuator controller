
int inputPositionPotPin = A0;    // analogue input pin of input position potentiometer
int actuatorPositionPotPin = A2; // analogue input pin of actuator position potentiometer
int actuatorDirOutputPin = 44; //digital output pin for direction of motor 
int actuatorSpeedOutputPin = 3 ; //analouge PWM output pin - note needs to be consitant with the PWM frequency changes in setup. 

int inputPositionPotValue = 0; // store of input potentiometer raw value
float inputPosition = 0; //store of mapped input position (0-255)

int actuatorPositionPotValue = 0; //store of actuator position potentiometer raw value
float actuatorPosition = 0; // store of mapped actuator position (0-255)

int actuatorDir = LOW; //store of actuator direction 
float  actuatorSpeed = 128;//store of actuaor speed
float actuatorFullSpeed= 50; //value of full speed of actuator (denoted C)

float  residualError = 0; // store of the difference between the desired position and the actual position
float residualRolloffStart = 600; // residual value where speed begind linear roll off (denoted (b)
float residualStop = 100
; // residual value where speed becomes zero (denoted a)


void setup() {
  Serial.begin(9600);
 
pinMode(actuatorDirOutputPin,OUTPUT);

 //setting the PWM frequency to 32khz
int myEraser = 7;
TCCR3B &= ~myEraser;
int myPrescaler = 1;
TCCR3B |= myPrescaler; 
}

void loop() {  
inputPositionPotValue = analogRead(inputPositionPotPin);
inputPosition = map(inputPositionPotValue,0,1023,0,10000);

actuatorPositionPotValue = analogRead (actuatorPositionPotPin);
actuatorPosition = map (actuatorPositionPotValue, 0,1023,0,10000);

residualError = inputPosition - actuatorPosition;

//if statements to set direction
if (residualError<0) 
{actuatorDir = LOW;}
else
{actuatorDir = HIGH;}

//if statements to set speed

if (abs(residualError)<residualStop)
{actuatorSpeed=0;}

else if 
(abs(residualError)<residualRolloffStart)
{actuatorSpeed = (abs(residualError)*actuatorFullSpeed) /(residualRolloffStart-residualStop) - (residualRolloffStart*actuatorFullSpeed)/(residualRolloffStart-residualStop)
+actuatorFullSpeed;}
else 
{actuatorSpeed = actuatorFullSpeed;}


//add simplke high pass filter to actuatr speed
if (actuatorSpeed < 10)
{actuatorSpeed = 0;}

// detect if direction has changed and slow speed
if 

//write values to output pins

digitalWrite(actuatorDirOutputPin,actuatorDir);
analogWrite (actuatorSpeedOutputPin, actuatorSpeed);
delay(1);
 Serial.print ("Input_position = "); Serial.print(inputPosition); 
 Serial.print (" Actuator_position = "); Serial.print(actuatorPosition) ;
 Serial.print (" Residual_error = "); Serial.print(residualError) ;
 Serial.print (" Actuator_Speed = "); Serial.print(actuatorSpeed) ;
Serial.print (" Residual_error = "); Serial.print(residualError) ;
 Serial.print (" residualStop = "); Serial.print(residualStop) ;
  Serial.print (" residualRolloffStart = "); Serial.print(residualRolloffStart);
Serial.print (" term1 = "); Serial.print((abs(residualError)*actuatorFullSpeed) /(residualRolloffStart-residualStop));
Serial.print (" term2 = "); Serial.print((residualRolloffStart*actuatorFullSpeed)/(residualRolloffStart-residualStop));      
  Serial.print('\n');
  }
